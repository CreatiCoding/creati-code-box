# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    branches:
      only:
        - deploy/master/frontend
        - deploy/develop/frontend
        - deploy/master/backend
        - deploy/develop/backend
    docker:
      - image: creaticoding/alpine:1.0.0
    steps:
      - add_ssh_keys:
          fingerprints:
            - 'be:45:07:d4:ae:48:21:d9:ca:5d:ef:c2:41:03:ba:d9'
      # - checkout
      - run:
          name: deploy
          command: |
            ls -al ~/.ssh/$SSH_FILE
            pwd
            if [ "$CIRCLE_BRANCH" = "deploy/master/frontend" ]; then
              echo 'master'
              ssh ubuntu@$SERVER_HOSTNAME -i ~/.ssh/$SSH_FILE -o StrictHostKeyChecking=no 'sudo pgrep -f nuxt | xargs kill -9; sudo rm -rf master_frontend; mkdir master_frontend; cd master_frontend; git clone --branch deploy/master/frontend https://github.com/CreatiCoding/creati-code-box; cd creati-code-box; nohup ./deploy.sh </dev/null >/dev/null 2>&1 &;'
            elif [ "$CIRCLE_BRANCH" = "deploy/develop/frontend" ]; then
              ssh ubuntu@$SERVER_HOSTNAME -i ~/.ssh/$SSH_FILE -o StrictHostKeyChecking=no '
              sudo rm -rf develop_frontend
              mkdir develop_frontend
              cd develop_frontend
              git clone --branch deploy/develop/frontend https://github.com/CreatiCoding/creati-code-box && cd creati-code-box
              '
              ssh ubuntu@$SERVER_HOSTNAME -i ~/.ssh/$SSH_FILE -o StrictHostKeyChecking=no '/bin/sh -c "cd ./develop_frontend/creati-code-box; nohup ./deploy.sh </dev/null >/dev/null 2>&1 &" 2>/dev/null'
              echo 'success'
            else
              echo 'pass'
            fi
